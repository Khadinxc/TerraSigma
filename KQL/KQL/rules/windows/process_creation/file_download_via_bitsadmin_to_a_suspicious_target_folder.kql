// Title: File Download Via Bitsadmin To A Suspicious Target Folder
// Author: Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)
// Date: 2022-06-28
// Level: high
// Description: Detects usage of bitsadmin downloading a file to a suspicious target folder
// MITRE Tactic: Defense Evasion
// Tags: attack.defense-evasion, attack.persistence, attack.t1197, attack.s0190, attack.t1036.003, attack.command-and-control, attack.t1105

DeviceProcessEvents
| where (ProcessCommandLine contains " /transfer " or ProcessCommandLine contains " /create " or ProcessCommandLine contains " /addfile ") and (ProcessCommandLine contains ":\\Perflogs" or ProcessCommandLine contains ":\\ProgramData\\" or ProcessCommandLine contains ":\\Temp\\" or ProcessCommandLine contains ":\\Users\\Public\\" or ProcessCommandLine contains ":\\Windows\\" or ProcessCommandLine contains "\\$Recycle.Bin\\" or ProcessCommandLine contains "\\AppData\\Local\\" or ProcessCommandLine contains "\\AppData\\Roaming\\" or ProcessCommandLine contains "\\Contacts\\" or ProcessCommandLine contains "\\Desktop\\" or ProcessCommandLine contains "\\Favorites\\" or ProcessCommandLine contains "\\Favourites\\" or ProcessCommandLine contains "\\inetpub\\wwwroot\\" or ProcessCommandLine contains "\\Music\\" or ProcessCommandLine contains "\\Pictures\\" or ProcessCommandLine contains "\\Start Menu\\Programs\\Startup\\" or ProcessCommandLine contains "\\Users\\Default\\" or ProcessCommandLine contains "\\Videos\\" or ProcessCommandLine contains "%ProgramData%" or ProcessCommandLine contains "%public%" or ProcessCommandLine contains "%temp%" or ProcessCommandLine contains "%tmp%") and (FolderPath endswith "\\bitsadmin.exe" or ProcessVersionInfoOriginalFileName =~ "bitsadmin.exe")