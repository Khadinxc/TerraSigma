resource "azurerm_sentinel_alert_rule_scheduled" "linux_suspicious_child_process_from_node_js_react2shell" {
  name                       = "linux_suspicious_child_process_from_node_js_react2shell"
  log_analytics_workspace_id = var.workspace_id
  display_name               = "Linux Suspicious Child Process from Node.js - React2Shell"
  description                = "Detects suspicious child processes spawned from Node.js server processes on Linux systems, potentially indicating remote code execution exploitation such as CVE-2025-55182 (React2Shell). This rule particularly looks for exploitation of vulnerability on Node.js Servers where attackers abuse Node.js child_process module to execute arbitrary system commands. When execSync() or exec() is used, the command line often includes a shell invocation followed by suspicious commands or scripts (e.g., /bin/sh -c <malicious-command>). For other methods, the Image field will show the spawned process directly."
  severity                   = "High"
  query                      = <<QUERY
DeviceProcessEvents
| where ((InitiatingProcessCommandLine contains "--experimental-https" or InitiatingProcessCommandLine contains "--experimental-next-config-strip-types" or InitiatingProcessCommandLine contains "/node_modules/next" or InitiatingProcessCommandLine contains "next dev" or InitiatingProcessCommandLine contains "next start" or InitiatingProcessCommandLine contains "node_modules/.bin" or InitiatingProcessCommandLine contains "react-scripts start" or InitiatingProcessCommandLine contains "start-server.js") and InitiatingProcessFolderPath endswith "/node") and (((ProcessCommandLine contains "/dev/tcp/" or ProcessCommandLine contains "/dev/udp/" or ProcessCommandLine contains "/etc/hosts" or ProcessCommandLine contains "/etc/passwd" or ProcessCommandLine contains "/etc/shadow" or ProcessCommandLine contains "base64" or ProcessCommandLine contains "cat " or ProcessCommandLine contains "curl" or ProcessCommandLine contains "dig" or ProcessCommandLine contains "ifconfig" or ProcessCommandLine contains "IO::Socket::INET" or ProcessCommandLine contains "java" or ProcessCommandLine contains "less " or ProcessCommandLine contains "lua" or ProcessCommandLine contains "mkfifo " or ProcessCommandLine contains "more" or ProcessCommandLine contains "nc " or ProcessCommandLine contains "ncat" or ProcessCommandLine contains "netcat" or ProcessCommandLine contains "netstat" or ProcessCommandLine contains "nslookup" or ProcessCommandLine contains "perl" or ProcessCommandLine contains "php" or ProcessCommandLine contains "ping" or ProcessCommandLine contains "ps -ef" or ProcessCommandLine contains "ps aux" or ProcessCommandLine contains "python" or ProcessCommandLine contains "rcat" or ProcessCommandLine contains "ruby" or ProcessCommandLine contains "sh -i 2>&1" or ProcessCommandLine contains "-c id" or ProcessCommandLine contains "socat" or ProcessCommandLine contains "uname" or ProcessCommandLine contains "wget" or ProcessCommandLine contains "whoami") or ((FolderPath endswith "/busybox" or FolderPath endswith "/cat" or FolderPath endswith "/curl" or FolderPath endswith "/dash" or FolderPath endswith "/dig" or FolderPath endswith "/head" or FolderPath endswith "/id" or FolderPath endswith "/ifconfig" or FolderPath endswith "/ip" or FolderPath endswith "/java" or FolderPath endswith "/less" or FolderPath endswith "/lua" or FolderPath endswith "/more" or FolderPath endswith "/nc" or FolderPath endswith "/ncat" or FolderPath endswith "/netcat" or FolderPath endswith "/netstat" or FolderPath endswith "/nslookup" or FolderPath endswith "/perl" or FolderPath endswith "/ping" or FolderPath endswith "/python" or FolderPath endswith "/python2" or FolderPath endswith "/ruby" or FolderPath endswith "/socat" or FolderPath endswith "/tail" or FolderPath endswith "/wget" or FolderPath endswith "/whoami") or FolderPath contains "/python")) or (FolderPath endswith "/sh" and (not(FolderPath endswith "-c"))) or ((FolderPath endswith "-c" and FolderPath endswith "/sh") and (ProcessCommandLine contains "/dev/tcp/" or ProcessCommandLine contains "/dev/udp/" or ProcessCommandLine contains "/etc/hosts" or ProcessCommandLine contains "/etc/passwd" or ProcessCommandLine contains "/etc/shadow" or ProcessCommandLine contains "base64" or ProcessCommandLine contains "cat " or ProcessCommandLine contains "curl" or ProcessCommandLine contains "dig" or ProcessCommandLine contains "ifconfig" or ProcessCommandLine contains "IO::Socket::INET" or ProcessCommandLine contains "java" or ProcessCommandLine contains "less " or ProcessCommandLine contains "lua" or ProcessCommandLine contains "mkfifo " or ProcessCommandLine contains "more" or ProcessCommandLine contains "nc " or ProcessCommandLine contains "ncat" or ProcessCommandLine contains "netcat" or ProcessCommandLine contains "netstat" or ProcessCommandLine contains "nslookup" or ProcessCommandLine contains "perl" or ProcessCommandLine contains "php" or ProcessCommandLine contains "ping" or ProcessCommandLine contains "ps -ef" or ProcessCommandLine contains "ps aux" or ProcessCommandLine contains "python" or ProcessCommandLine contains "rcat" or ProcessCommandLine contains "ruby" or ProcessCommandLine contains "sh -i 2>&1" or ProcessCommandLine contains "-c id" or ProcessCommandLine contains "socat" or ProcessCommandLine contains "uname" or ProcessCommandLine contains "wget" or ProcessCommandLine contains "whoami")))
QUERY
  query_frequency            = "PT1H"
  query_period               = "PT1H"
  trigger_operator           = "GreaterThan"
  trigger_threshold          = 0
  suppression_enabled        = false
  suppression_duration       = "PT5H"
  tactics                    = ["Execution", "InitialAccess"]
  techniques                 = ["T1059", "T1190"]
  enabled                    = true

  incident {
    create_incident_enabled = true
    grouping {
      enabled                 = false
      lookback_duration       = "PT5H"
      reopen_closed_incidents = false
      entity_matching_method  = "AllEntities"
      by_entities             = []
      by_alert_details        = []
      by_custom_details       = []
    }
  }

  event_grouping {
    aggregation_method = "SingleAlert"
  }

  entity_mapping {
    entity_type = "Account"
    field_mapping {
      identifier  = "Name"
      column_name = "InitiatingProcessAccountName"
    }
    field_mapping {
      identifier  = "NTDomain"
      column_name = "InitiatingProcessAccountDomain"
    }
    field_mapping {
      identifier  = "Sid"
      column_name = "InitiatingProcessAccountSid"
    }
    field_mapping {
      identifier  = "UPNSuffix"
      column_name = "InitiatingProcessAccountUpn"
    }
    field_mapping {
      identifier  = "AadUserId"
      column_name = "InitiatingProcessAccountObjectId"
    }
  }

  entity_mapping {
    entity_type = "Host"
    field_mapping {
      identifier  = "HostName"
      column_name = "DeviceName"
    }
    field_mapping {
      identifier  = "AzureID"
      column_name = "DeviceId"
    }
  }

  entity_mapping {
    entity_type = "Process"
    field_mapping {
      identifier  = "CommandLine"
      column_name = "ProcessCommandLine"
    }
  }

  entity_mapping {
    entity_type = "File"
    field_mapping {
      identifier  = "Directory"
      column_name = "FolderPath"
    }
  }
}